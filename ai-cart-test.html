<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Cart Total Tester</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --border:#e6e8ef;
      --text:#111;
      --muted:#6b7280;
      --accent:#2b6cb0;
      --accent-2:#2563eb;
      --danger:#b91c1c;
      --success:#059669;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
      line-height:1.4;
    }
    header{
      padding:20px 16px 10px;
      text-align:center;
      font-weight:700;
      font-size:22px;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:0 16px 40px;
      display:grid;
      gap:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
    }
    .dropzone{
      border:2px dashed #cbd5e1;
      border-radius:14px;
      padding:18px;
      text-align:center;
      background:#f9fafb;
    }
    .dropzone.dragover{border-color:var(--accent); background:#eef3ff}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .thumbs{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .thumbGroup{display:flex;flex-direction:column;gap:6px;align-items:center}
    .thumb{
      width:90px;height:90px;border:1px solid var(--border);border-radius:10px;
      background:#fff;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;
    }
    .thumb img{max-width:100%;max-height:100%;display:block}
    .roiWrap{display:flex;flex-direction:column;gap:4px;align-items:center}
    .roiLabel{font-size:10px;color:var(--muted);letter-spacing:.02em;text-transform:uppercase}
    .roiBox{
      width:90px;border-radius:8px;border:1px solid var(--border);
      background:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center;
    }
    .roiPreview{width:100%;height:auto;object-fit:contain;display:block}
    .thumb button{
      position:absolute;top:4px;right:4px;border:none;background:#000000a6;color:#fff;
      width:20px;height:20px;border-radius:50%;cursor:pointer;font-size:12px;line-height:1;
    }
    button{
      border:1px solid var(--border);background:#fff;padding:9px 12px;border-radius:10px;cursor:pointer;
    }
    button.primary{background:var(--accent-2);color:#fff;border-color:var(--accent-2)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .progressWrap{width:100%;background:#f1f5f9;border-radius:999px;height:10px;overflow:hidden}
    .progressBar{height:100%;background:var(--accent);width:0%}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;vertical-align:top}
    th{color:#555;font-weight:600}
    .small{font-size:12px}
    .statusLine{min-height:20px}
    .total{font-weight:700;font-size:20px}
    .pill{
      display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;
      background:#f8fafc;color:#374151;
    }
    .warn{color:#9a3412;background:#fff7ed;border:1px solid #fed7aa;padding:6px 10px;border-radius:8px}
    .err{color:var(--danger)}
    .resultsHeader{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .space{height:6px}
    .inline{display:inline-flex;align-items:center;gap:6px}
    input[type="checkbox"]{transform:scale(1.1)}
    .field{display:flex;flex-direction:column;gap:6px;max-width:520px}
    .field label{font-weight:600}
    .field input[type="password"]{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;
      background:#fff;color:var(--text);
    }
    .debugBlock{
      margin-top:12px;border:1px dashed var(--border);border-radius:10px;padding:10px;background:#fbfbfd;
      max-height:260px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:12px;white-space:pre-wrap;
    }
    .hidden{display:none}
  </style>
</head>
<body>
  <header>AI Cart Total Tester</header>
  <div class="wrap">
    <section class="card">
      <div class="field">
        <label for="apiKey">Gemini API Key</label>
        <input id="apiKey" type="password" placeholder="Paste your Gemini API key">
      </div>
      <div class="space"></div>
      <label class="inline">
        <input id="rememberKey" type="checkbox">
        Remember in this browser
      </label>
      <div class="muted small">Your key is stored locally only when this is checked.</div>
    </section>

    <section class="card">
      <div id="dropzone" class="dropzone">
        <div>Paste images (Ctrl+V), drag &amp; drop, or choose files</div>
        <div class="space"></div>
        <label class="pill" style="cursor:pointer">
          Choose Files
          <input id="fileInput" type="file" accept="image/*" multiple style="display:none">
        </label>
        <div class="space"></div>
        <div class="muted">Images: <span id="imageCount">0</span></div>
        <div id="thumbs" class="thumbs"></div>
      </div>
    </section>

    <section class="card">
      <div class="controls">
        <button id="calcBtn" class="primary">Calculate Total</button>
        <button id="clearBtn">Clear</button>
        <span class="pill">Max 6 images per run</span>
      </div>
      <div class="space"></div>
      <div class="statusLine muted" id="statusText"></div>
      <div class="progressWrap"><div id="progressBar" class="progressBar"></div></div>
    </section>

    <section class="card">
      <div class="resultsHeader">
        <div class="total">Total: <span id="totalValue">0.00</span> ILS</div>
        <div class="row">
          <button id="copyBtn">Copy total</button>
          <label class="inline small">
            <input id="debugToggle" type="checkbox">
            Show raw model response (debug)
          </label>
        </div>
      </div>
      <div class="space"></div>
      <div class="muted small">Model total: <span id="modelTotal">—</span> ILS</div>
      <div class="space"></div>
      <div id="warningsWrap"></div>
      <div class="space"></div>
      <div id="resultsWrap"></div>
      <div id="debugWrap" class="debugBlock hidden"></div>
    </section>
  </div>

  <script>
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const thumbs = document.getElementById("thumbs");
    const imageCount = document.getElementById("imageCount");
    const calcBtn = document.getElementById("calcBtn");
    const clearBtn = document.getElementById("clearBtn");
    const statusText = document.getElementById("statusText");
    const progressBar = document.getElementById("progressBar");
    const resultsWrap = document.getElementById("resultsWrap");
    const totalValue = document.getElementById("totalValue");
    const copyBtn = document.getElementById("copyBtn");
    const apiKeyInput = document.getElementById("apiKey");
    const rememberKey = document.getElementById("rememberKey");
    const warningsWrap = document.getElementById("warningsWrap");
    const debugToggle = document.getElementById("debugToggle");
    const debugWrap = document.getElementById("debugWrap");
    const modelTotal = document.getElementById("modelTotal");

    const MAX_IMAGES = 6;
    const STORAGE_KEY = "geminiApiKey";
    let images = [];
    let running = false;
    let currentItems = [];
    let lastRawResponse = "";

    const PROMPT_BASE = [
      "These images are SHEIN cart/list screenshots.",
      "Many numbers appear that are NOT prices (time, battery, cart count, discounts, percentages).",
      "Extract ONLY the current item prices.",
      "Ignore: percentages (e.g. -25%), old/strikethrough prices, time, battery, cart badge numbers.",
      "If both old and sale prices appear for an item, choose the LOWER price.",
      "Currency is ILS (₪).",
      "Return STRICT JSON ONLY. No markdown, no explanation.",
      "Required JSON schema:",
      "{",
      "  \"currency\": \"ILS\",",
      "  \"items\": [",
      "    { \"name\": \"string\", \"price\": 0.0, \"notes\": \"optional\" }",
      "  ],",
      "  \"total\": 0.0,",
      "  \"warnings\": [\"string\"]",
      "}"
    ].join("\n");

    function buildPrompt(isStrict){
      if(isStrict){
        return PROMPT_BASE + "\nReturn valid JSON ONLY. No text outside JSON.";
      }
      return PROMPT_BASE;
    }

    function setStatus(message, isError){
      statusText.textContent = message || "";
      statusText.classList.toggle("err", Boolean(isError));
      statusText.classList.toggle("muted", !isError);
    }

    function updateProgress(pct){
      progressBar.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    }

    function loadSavedKey(){
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved){
        apiKeyInput.value = saved;
        rememberKey.checked = true;
      }
    }

    function maybePersistKey(){
      if(rememberKey.checked){
        const val = apiKeyInput.value.trim();
        if(val){
          localStorage.setItem(STORAGE_KEY, val);
        }
      }
    }

    rememberKey.addEventListener("change", () => {
      if(!rememberKey.checked){
        localStorage.removeItem(STORAGE_KEY);
      }else{
        maybePersistKey();
      }
    });

    apiKeyInput.addEventListener("input", () => {
      if(rememberKey.checked){
        maybePersistKey();
      }
    });

    loadSavedKey();

    function loadImageFromUrl(url){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.decoding = "async";
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    async function buildRoiCanvasFromFile(file, url){
      const sourceUrl = url || URL.createObjectURL(file);
      const img = await loadImageFromUrl(sourceUrl);
      const width = img.naturalWidth || img.width;
      const height = img.naturalHeight || img.height;
      const baseCanvas = document.createElement("canvas");
      baseCanvas.width = width;
      baseCanvas.height = height;
      const baseCtx = baseCanvas.getContext("2d");
      baseCtx.drawImage(img, 0, 0);

      if(!url){
        URL.revokeObjectURL(sourceUrl);
      }

      const roiCanvas = baseCanvas;

      return {
        roiCanvas,
        roiUrl: roiCanvas.toDataURL("image/png")
      };
    }

    async function addImagesFromFiles(fileList){
      const files = Array.from(fileList || []).filter(f => f.type.startsWith("image/"));
      for(const file of files){
        const url = URL.createObjectURL(file);
        let roiCanvas = null;
        let roiUrl = null;
        try{
          const roi = await buildRoiCanvasFromFile(file, url);
          roiCanvas = roi.roiCanvas;
          roiUrl = roi.roiUrl;
        }catch(err){
          console.error("ROI build failed", err);
        }
        images.push({ file, url, roiCanvas, roiUrl });
      }
      renderThumbnails();
    }

    async function addImagesFromClipboard(e){
      const items = Array.from(e.clipboardData?.items || []);
      const files = items
        .filter(it => it.type.startsWith("image/"))
        .map(it => it.getAsFile())
        .filter(Boolean);
      if(files.length){
        e.preventDefault();
        await addImagesFromFiles(files);
      }
    }

    function renderThumbnails(){
      thumbs.innerHTML = "";
      images.forEach((img, idx) => {
        const group = document.createElement("div");
        group.className = "thumbGroup";

        const div = document.createElement("div");
        div.className = "thumb";
        const image = document.createElement("img");
        image.src = img.url;
        div.appendChild(image);
        if(img.roiUrl){
          const roiWrap = document.createElement("div");
          roiWrap.className = "roiWrap";
          const roiLabel = document.createElement("div");
          roiLabel.className = "roiLabel";
          roiLabel.textContent = "Preview";
          const roiBox = document.createElement("div");
          roiBox.className = "roiBox";
          const roiPreview = document.createElement("img");
          roiPreview.className = "roiPreview";
          roiPreview.src = img.roiUrl;
          roiPreview.title = "Gemini preview";
          roiBox.appendChild(roiPreview);
          roiWrap.appendChild(roiLabel);
          roiWrap.appendChild(roiBox);
          group.appendChild(roiWrap);
        }
        const btn = document.createElement("button");
        btn.textContent = "×";
        btn.setAttribute("aria-label", "إزالة الصورة");
        btn.title = "إزالة الصورة";
        btn.onclick = () => {
          URL.revokeObjectURL(img.url);
          images = images.filter((_, i) => i !== idx);
          renderThumbnails();
        };
        div.appendChild(btn);
        group.appendChild(div);
        thumbs.appendChild(group);
      });
      imageCount.textContent = images.length;
    }

    function resetUI(){
      setStatus("", false);
      updateProgress(0);
      resultsWrap.innerHTML = "";
      warningsWrap.innerHTML = "";
      totalValue.textContent = "0.00";
      modelTotal.textContent = "—";
      debugWrap.textContent = "";
      lastRawResponse = "";
    }

    function canvasToJpegBase64(canvas){
      const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
      return dataUrl.split(",")[1] || "";
    }

    function extractModelText(apiResponse){
      const parts = apiResponse?.candidates?.[0]?.content?.parts || [];
      const text = parts.map(part => part.text).filter(Boolean).join("").trim();
      return text;
    }

    function extractFirstJsonBlock(text){
      const start = text.indexOf("{");
      if(start === -1) return null;
      let depth = 0;
      for(let i = start; i < text.length; i++){
        const ch = text[i];
        if(ch === "{") depth += 1;
        if(ch === "}"){
          depth -= 1;
          if(depth === 0){
            return text.slice(start, i + 1);
          }
        }
      }
      return null;
    }

    function tryParseJson(text){
      if(!text) return { ok:false, error: "Empty response" };
      try{
        return { ok:true, data: JSON.parse(text) };
      }catch(err){
        const block = extractFirstJsonBlock(text);
        if(block){
          try{
            return { ok:true, data: JSON.parse(block) };
          }catch(parseErr){
            return { ok:false, error: parseErr?.message || "Invalid JSON" };
          }
        }
        return { ok:false, error: err?.message || "Invalid JSON" };
      }
    }

    async function callGemini({ apiKey, imageParts, strict }){
      const parts = [{ text: buildPrompt(strict) }, ...imageParts];
      const body = {
        contents: [{ role: "user", parts }],
        generationConfig: {
          temperature: 0.1,
          maxOutputTokens: 1024
        }
      };
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${encodeURIComponent(apiKey)}`;
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const payload = await res.json().catch(() => null);
      if(!res.ok){
        const msg = payload?.error?.message || `Gemini request failed (${res.status})`;
        throw new Error(msg);
      }
      const text = extractModelText(payload);
      if(!text){
        throw new Error("Gemini returned an empty response.");
      }
      return { text, payload };
    }

    function renderWarnings(warnings){
      warningsWrap.innerHTML = "";
      if(!Array.isArray(warnings) || !warnings.length) return;
      warnings.forEach(warn => {
        const div = document.createElement("div");
        div.className = "warn small";
        div.textContent = warn;
        warningsWrap.appendChild(div);
      });
    }

    function renderResults(data){
      const items = Array.isArray(data?.items) ? data.items : [];
      currentItems = items.map(item => ({
        name: typeof item?.name === "string" ? item.name : "",
        price: Number(item?.price),
        notes: typeof item?.notes === "string" ? item.notes : ""
      }));

      if(Number.isFinite(Number(data?.total))){
        modelTotal.textContent = Number(data.total).toFixed(2);
      }else{
        modelTotal.textContent = "—";
      }

      renderWarnings(Array.isArray(data?.warnings) ? data.warnings : []);

      if(!currentItems.length){
        resultsWrap.innerHTML = "<div class='muted'>No items detected.</div>";
        totalValue.textContent = "0.00";
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Include</th>
          <th>Item</th>
          <th>Price (ILS)</th>
          <th>Notes</th>
        </tr>
      `;
      table.appendChild(thead);
      const tbody = document.createElement("tbody");

      currentItems.forEach((item, idx) => {
        const tr = document.createElement("tr");
        const includeCell = document.createElement("td");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = true;
        cb.dataset.index = String(idx);
        cb.addEventListener("change", computeTotal);
        includeCell.appendChild(cb);

        const nameCell = document.createElement("td");
        nameCell.textContent = item.name || `Item ${idx + 1}`;

        const priceCell = document.createElement("td");
        const price = Number(item.price);
        priceCell.textContent = Number.isFinite(price) ? price.toFixed(2) : "0.00";

        const notesCell = document.createElement("td");
        notesCell.textContent = item.notes || "";

        tr.appendChild(includeCell);
        tr.appendChild(nameCell);
        tr.appendChild(priceCell);
        tr.appendChild(notesCell);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      resultsWrap.innerHTML = "";
      resultsWrap.appendChild(table);
      computeTotal();
    }

    function computeTotal(){
      const checks = resultsWrap.querySelectorAll("input[type='checkbox']");
      let sum = 0;
      checks.forEach(cb => {
        if(cb.checked){
          const idx = Number(cb.dataset.index);
          const item = currentItems[idx];
          const val = Number(item?.price);
          if(Number.isFinite(val)) sum += val;
        }
      });
      totalValue.textContent = sum.toFixed(2);
      return sum;
    }

    async function processImages(){
      if(running) return;
      const apiKey = apiKeyInput.value.trim();
      if(!apiKey){
        setStatus("Please enter your Gemini API key.", true);
        return;
      }
      if(!images.length){
        resultsWrap.innerHTML = "<div class='muted'>Add images first.</div>";
        return;
      }

      running = true;
      calcBtn.disabled = true;
      clearBtn.disabled = true;
      resetUI();

      const runImages = images.slice(0, MAX_IMAGES);
      if(images.length > MAX_IMAGES){
        setStatus(`Only the first ${MAX_IMAGES} images will be processed this run.`, false);
      }else{
        setStatus("Preparing images...", false);
      }
      updateProgress(10);

      const imageParts = [];
      try{
        for(let i = 0; i < runImages.length; i++){
          const img = runImages[i];
          if(!img.roiCanvas){
            const roi = await buildRoiCanvasFromFile(img.file, img.url);
            img.roiCanvas = roi.roiCanvas;
            if(!img.roiUrl){
              img.roiUrl = roi.roiUrl;
              renderThumbnails();
            }
          }
          const base64 = canvasToJpegBase64(img.roiCanvas);
          if(!base64){
            throw new Error(`Failed to prepare image ${i + 1}.`);
          }
          imageParts.push({
            inline_data: { mime_type: "image/jpeg", data: base64 }
          });
          updateProgress(10 + Math.round(((i + 1) / runImages.length) * 40));
        }

        setStatus("Sending to Gemini...", false);
        updateProgress(60);

        let response = await callGemini({ apiKey, imageParts, strict: false });
        lastRawResponse = response.text;
        let parsed = tryParseJson(response.text);

        if(!parsed.ok){
          setStatus("Trying a stricter prompt...", false);
          updateProgress(70);
          response = await callGemini({ apiKey, imageParts, strict: true });
          lastRawResponse = response.text;
          parsed = tryParseJson(response.text);
        }

        if(!parsed.ok){
          throw new Error("Gemini returned invalid JSON even after retry.");
        }

        updateProgress(90);
        renderResults(parsed.data);
        debugWrap.textContent = lastRawResponse;
        if(debugToggle.checked){
          debugWrap.classList.remove("hidden");
        }
        setStatus("Done.", false);
        updateProgress(100);
      }catch(err){
        console.error(err);
        setStatus(err?.message || "Something went wrong.", true);
      }finally{
        calcBtn.disabled = false;
        clearBtn.disabled = false;
        running = false;
      }
    }

    function clearAll(){
      images.forEach(i => URL.revokeObjectURL(i.url));
      images = [];
      renderThumbnails();
      resetUI();
    }

    copyBtn.onclick = async () => {
      const val = totalValue.textContent;
      try{
        await navigator.clipboard.writeText(val);
        setStatus("Total copied.", false);
      }catch(err){
        setStatus("Copy failed.", true);
      }
    };

    debugToggle.addEventListener("change", () => {
      if(debugToggle.checked){
        debugWrap.textContent = lastRawResponse || "(no response yet)";
        debugWrap.classList.remove("hidden");
      }else{
        debugWrap.classList.add("hidden");
      }
    });

    calcBtn.onclick = processImages;
    clearBtn.onclick = clearAll;

    fileInput.addEventListener("change", (e) => addImagesFromFiles(e.target.files));

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("dragover");
    });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      addImagesFromFiles(e.dataTransfer.files);
    });

    document.addEventListener("paste", addImagesFromClipboard);
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Cart Total Tester</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --border:#e6e8ef;
      --text:#111;
      --muted:#6b7280;
      --accent:#2b6cb0;
      --accent-2:#2563eb;
      --danger:#c2410c;
      --success:#059669;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
      line-height:1.4;
    }
    header{
      padding:20px 16px 10px;
      text-align:center;
      font-weight:700;
      font-size:22px;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:0 16px 40px;
      display:grid;
      gap:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
    }
    .dropzone{
      border:2px dashed #cbd5e1;
      border-radius:14px;
      padding:18px;
      text-align:center;
      background:#f9fafb;
    }
    .dropzone.dragover{border-color:var(--accent); background:#eef3ff}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .thumbs{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .thumbGroup{display:flex;flex-direction:column;gap:6px;align-items:center}
    .thumb{
      width:90px;height:90px;border:1px solid var(--border);border-radius:10px;
      background:#fff;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;
    }
    .thumb img{max-width:100%;max-height:100%;display:block}
    .roiWrap{display:flex;flex-direction:column;gap:4px;align-items:center}
    .roiLabel{font-size:10px;color:var(--muted);letter-spacing:.02em;text-transform:uppercase}
    .roiBox{
      width:54px;height:54px;border-radius:8px;border:1px solid var(--border);
      background:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center;
    }
    .roiPreview{width:100%;height:100%;object-fit:cover;display:block}
    .thumb button{
      position:absolute;top:4px;right:4px;border:none;background:#000000a6;color:#fff;
      width:20px;height:20px;border-radius:50%;cursor:pointer;font-size:12px;line-height:1;
    }
    button{
      border:1px solid var(--border);background:#fff;padding:9px 12px;border-radius:10px;cursor:pointer;
    }
    button.primary{background:var(--accent-2);color:#fff;border-color:var(--accent-2)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .progressWrap{width:100%;background:#f1f5f9;border-radius:999px;height:10px;overflow:hidden}
    .progressBar{height:100%;background:var(--accent);width:0%}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;vertical-align:top}
    th{color:#555;font-weight:600}
    .small{font-size:12px}
    .statusLine{min-height:20px}
    .total{font-weight:700;font-size:20px}
    .pill{
      display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;
      background:#f8fafc;color:#374151;
    }
    .warn{color:#9a3412;background:#fff7ed;border:1px solid #fed7aa;padding:6px 10px;border-radius:8px}
    .resultsHeader{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .snippet{color:#6b7280}
    .conf{color:#0f766e}
    .ignored{color:#9ca3af;text-decoration:line-through}
    .err{color:#b91c1c}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .space{height:6px}
    .inline{display:inline-flex;align-items:center;gap:6px}
    input[type="checkbox"]{transform:scale(1.1)}
  </style>
</head>
<body>
  <header>AI Cart Total Tester</header>
  <div class="wrap">
    <section class="card">
      <div id="dropzone" class="dropzone">
        <div>Paste images (Ctrl+V), drag &amp; drop, or choose files</div>
        <div class="space"></div>
        <label class="pill" style="cursor:pointer">
          Choose Files
          <input id="fileInput" type="file" accept="image/*" multiple style="display:none">
        </label>
        <div class="space"></div>
        <div class="muted">Images: <span id="imageCount">0</span></div>
        <div id="thumbs" class="thumbs"></div>
      </div>
    </section>

    <section class="card">
      <div class="controls">
        <button id="calcBtn" class="primary">Calculate Total</button>
        <button id="clearBtn">Clear</button>
        <label class="inline">
          <input id="preprocessToggle" type="checkbox">
          Use preprocessing (OpenCV threshold)
        </label>
      </div>
      <div class="space"></div>
      <div class="statusLine muted" id="statusText"></div>
      <div class="progressWrap"><div id="progressBar" class="progressBar"></div></div>
      <div class="space"></div>
      <div class="muted small" id="opencvStatus"></div>
    </section>

    <section class="card">
      <div class="resultsHeader">
        <div class="total">Total: <span id="totalValue">0.00</span> ILS</div>
        <div class="row">
          <button id="copyBtn">Copy total</button>
          <span class="warn small">OCR is imperfect — verify.</span>
        </div>
      </div>
      <div class="space"></div>
      <div id="resultsWrap"></div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://docs.opencv.org/4.x/opencv.js" async></script>
  <script>
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const thumbs = document.getElementById("thumbs");
    const imageCount = document.getElementById("imageCount");
    const calcBtn = document.getElementById("calcBtn");
    const clearBtn = document.getElementById("clearBtn");
    const preprocessToggle = document.getElementById("preprocessToggle");
    const statusText = document.getElementById("statusText");
    const progressBar = document.getElementById("progressBar");
    const resultsWrap = document.getElementById("resultsWrap");
    const totalValue = document.getElementById("totalValue");
    const copyBtn = document.getElementById("copyBtn");
    const opencvStatus = document.getElementById("opencvStatus");

    let images = [];
    let worker = null;
    let ocrRunning = false;
    let opencvReady = false;

    function updateOpenCVStatus(){
      if(opencvReady){
        opencvStatus.textContent = "OpenCV loaded. Preprocessing is available.";
        preprocessToggle.checked = true;
      }else{
        opencvStatus.textContent = "OpenCV not ready. Preprocessing will be disabled.";
        preprocessToggle.checked = false;
      }
      preprocessToggle.disabled = !opencvReady;
    }

    if(window.cv){
      opencvReady = true;
      updateOpenCVStatus();
    }else{
      window.Module = {
        onRuntimeInitialized() {
          opencvReady = true;
          updateOpenCVStatus();
        }
      };
      updateOpenCVStatus();
    }

    function loadImageFromUrl(url){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.decoding = "async";
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    async function buildRoiCanvasFromFile(file, url){
      const sourceUrl = url || URL.createObjectURL(file);
      const img = await loadImageFromUrl(sourceUrl);
      const width = img.naturalWidth || img.width;
      const height = img.naturalHeight || img.height;
      const baseCanvas = document.createElement("canvas");
      baseCanvas.width = width;
      baseCanvas.height = height;
      const baseCtx = baseCanvas.getContext("2d");
      baseCtx.drawImage(img, 0, 0);

      if(!url){
        URL.revokeObjectURL(sourceUrl);
      }

      const cropTop = Math.round(height * 0.14);
      const cropBottom = Math.round(height * 0.14);
      const cropLeft = Math.round(width * 0.00);
      const cropRight = Math.round(width * 0.22);
      const roiWidth = Math.max(1, width - cropLeft - cropRight);
      const roiHeight = Math.max(1, height - cropTop - cropBottom);

      const roiCanvas = document.createElement("canvas");
      roiCanvas.width = roiWidth;
      roiCanvas.height = roiHeight;
      const roiCtx = roiCanvas.getContext("2d");
      roiCtx.drawImage(
        baseCanvas,
        cropLeft,
        cropTop,
        roiWidth,
        roiHeight,
        0,
        0,
        roiWidth,
        roiHeight
      );

      return {
        roiCanvas,
        roiUrl: roiCanvas.toDataURL("image/png")
      };
    }

    async function addImagesFromFiles(fileList){
      const files = Array.from(fileList || []).filter(f => f.type.startsWith("image/"));
      for(const file of files){
        const url = URL.createObjectURL(file);
        let roiCanvas = null;
        let roiUrl = null;
        try{
          const roi = await buildRoiCanvasFromFile(file, url);
          roiCanvas = roi.roiCanvas;
          roiUrl = roi.roiUrl;
        }catch(err){
          console.error("ROI build failed", err);
        }
        images.push({ file, url, roiCanvas, roiUrl });
      }
      renderThumbnails();
    }

    async function addImagesFromClipboard(e){
      const items = Array.from(e.clipboardData?.items || []);
      const files = items
        .filter(it => it.type.startsWith("image/"))
        .map(it => it.getAsFile())
        .filter(Boolean);
      if(files.length){
        e.preventDefault();
        await addImagesFromFiles(files);
      }
    }

    function renderThumbnails(){
      thumbs.innerHTML = "";
      images.forEach((img, idx) => {
        const group = document.createElement("div");
        group.className = "thumbGroup";

        const div = document.createElement("div");
        div.className = "thumb";
        const image = document.createElement("img");
        image.src = img.url;
        div.appendChild(image);
        if(img.roiUrl){
          const roiWrap = document.createElement("div");
          roiWrap.className = "roiWrap";
          const roiLabel = document.createElement("div");
          roiLabel.className = "roiLabel";
          roiLabel.textContent = "OCR crop";
          const roiBox = document.createElement("div");
          roiBox.className = "roiBox";
          const roiPreview = document.createElement("img");
          roiPreview.className = "roiPreview";
          roiPreview.src = img.roiUrl;
          roiPreview.title = "OCR ROI preview";
          roiBox.appendChild(roiPreview);
          roiWrap.appendChild(roiLabel);
          roiWrap.appendChild(roiBox);
          group.appendChild(roiWrap);
        }
        const btn = document.createElement("button");
        btn.textContent = "×";
        btn.onclick = () => {
          URL.revokeObjectURL(img.url);
          images = images.filter((_, i) => i !== idx);
          renderThumbnails();
        };
        div.appendChild(btn);
        group.appendChild(div);
        thumbs.appendChild(group);
      });
      imageCount.textContent = images.length;
    }

    function resetUI(){
      statusText.textContent = "";
      progressBar.style.width = "0%";
      resultsWrap.innerHTML = "";
      totalValue.textContent = "0.00";
    }

    async function ensureWorker(){
      if(worker) return worker;
      worker = await Tesseract.createWorker("eng");
      return worker;
    }

    async function preprocessCanvasOpenCV(canvas){
      if(!opencvReady) return canvas;
      try{
        const src = cv.imread(canvas);
        const gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        const dst = new cv.Mat();
        cv.threshold(gray, dst, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);
        const out = document.createElement("canvas");
        out.width = canvas.width;
        out.height = canvas.height;
        cv.imshow(out, dst);
        src.delete(); gray.delete(); dst.delete();
        return out;
      }catch(err){
        console.error(err);
        return canvas;
      }
    }

    async function ocrCanvas(canvas){
      const w = await ensureWorker();
      const { data } = await w.recognize(canvas);
      return data.text || "";
    }

    function normalizePriceToken(token){
      let s = token.replace(/[,]/g, ".").replace(/[^\d.]/g, "");
      if(!s) return null;
      if(s.split(".").length > 2) return null;
      const num = Number(s);
      if(!isFinite(num)) return null;
      return num;
    }

    function extractPricesFromText(text, imageIndex){
      const lines = text.split(/\n+/).map(l => l.trim()).filter(Boolean);
      const results = [];
      const seen = new Set();

      const currencyLine = /₪|ILS/i;
      const patterns = [
        /₪\s*([0-9]+[.,][0-9]{1,2})/g,
        /([0-9]+[.,][0-9]{1,2})\s*₪/g,
        /\bILS\s*([0-9]+[.,][0-9]{1,2})/gi,
        /([0-9]+[.,][0-9]{1,2})\s*ILS\b/gi
      ];

      lines.forEach(line => {
        if(!currencyLine.test(line)) return;
        if(/%/.test(line)) return;
        if(/:/.test(line)) return;

        const matches = [];
        patterns.forEach((re) => {
          re.lastIndex = 0;
          let match;
          while((match = re.exec(line)) !== null){
            const val = normalizePriceToken(match[1]);
            if(val === null) continue;
            matches.push({ value: val, raw: match[0] });
          }
        });

        if(!matches.length) return;

        matches.forEach(match => {
          const key = `${imageIndex}:${match.value.toFixed(2)}:${line}`;
          if(seen.has(key)) return;
          seen.add(key);
          results.push({
            value: match.value,
            currency: "ILS",
            imageIndex,
            raw: line,
            confidence: 0.65
          });
        });
      });

      return results;
    }

    function buildResultsUI(items){
      if(!items.length){
        resultsWrap.innerHTML = "<div class='muted'>No prices detected.</div>";
        return;
      }
      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Include</th>
            <th>Value</th>
            <th>Currency</th>
            <th>Image</th>
            <th>Snippet</th>
            <th>Confidence</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      items.forEach((item, idx) => {
        const tr = document.createElement("tr");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = true;
        cb.dataset.index = idx;
        cb.addEventListener("change", computeTotal);

        const ignoredText = item.ignoredOldPrices?.length
          ? `<div class="small ignored">ignored: ${item.ignoredOldPrices.join(", ")}</div>`
          : "";

        tr.innerHTML = `
          <td></td>
          <td>${item.value.toFixed(2)}</td>
          <td>${item.currency}</td>
          <td>#${item.imageIndex + 1}</td>
          <td class="snippet">${item.raw}${ignoredText}</td>
          <td class="conf">${Math.round(item.confidence * 100)}%</td>
        `;
        tr.children[0].appendChild(cb);
        tbody.appendChild(tr);
      });

      resultsWrap.innerHTML = "";
      resultsWrap.appendChild(table);
      computeTotal();
    }

    function computeTotal(){
      const checks = resultsWrap.querySelectorAll("input[type='checkbox']");
      let sum = 0;
      checks.forEach(cb => {
        if(cb.checked){
          const row = cb.closest("tr");
          const val = Number(row.children[1].textContent);
          if(isFinite(val)) sum += val;
        }
      });
      totalValue.textContent = sum.toFixed(2);
      return sum;
    }

    async function processImages(){
      if(ocrRunning) return;
      if(!images.length){
        resultsWrap.innerHTML = "<div class='muted'>Add images first.</div>";
        return;
      }
      ocrRunning = true;
      calcBtn.disabled = true;
      resetUI();

      const allResults = [];
      for(let i=0; i<images.length; i++){
        statusText.textContent = `Processing image ${i+1}/${images.length}...`;
        progressBar.style.width = `${Math.round((i / images.length) * 100)}%`;

        const img = images[i];
        let inputCanvas = img.roiCanvas;
        if(!inputCanvas){
          try{
            const roi = await buildRoiCanvasFromFile(img.file, img.url);
            inputCanvas = roi.roiCanvas;
            if(!img.roiUrl){
              img.roiUrl = roi.roiUrl;
              renderThumbnails();
            }
          }catch(err){
            console.error("ROI build failed", err);
          }
        }
        if(!inputCanvas){
          const fallbackImg = await loadImageFromUrl(img.url);
          const fallback = document.createElement("canvas");
          const width = fallbackImg.naturalWidth || fallbackImg.width;
          const height = fallbackImg.naturalHeight || fallbackImg.height;
          fallback.width = width;
          fallback.height = height;
          const ctx = fallback.getContext("2d");
          ctx.drawImage(fallbackImg, 0, 0);
          inputCanvas = fallback;
        }

        if(preprocessToggle.checked && opencvReady){
          inputCanvas = await preprocessCanvasOpenCV(inputCanvas);
        }
        try{
          const text = await ocrCanvas(inputCanvas);
          const prices = extractPricesFromText(text, i);
          allResults.push(...prices);
        }catch(err){
          console.error(err);
          resultsWrap.innerHTML += `<div class="err small">OCR failed for image ${i+1}.</div>`;
        }
      }
      progressBar.style.width = "100%";
      statusText.textContent = "Done.";
      buildResultsUI(allResults);
      calcBtn.disabled = false;
      ocrRunning = false;
    }

    function clearAll(){
      images.forEach(i => URL.revokeObjectURL(i.url));
      images = [];
      renderThumbnails();
      resetUI();
    }

    copyBtn.onclick = async () => {
      const val = totalValue.textContent;
      try{
        await navigator.clipboard.writeText(val);
        statusText.textContent = "Total copied.";
      }catch(err){
        statusText.textContent = "Copy failed.";
      }
    };

    calcBtn.onclick = processImages;
    clearBtn.onclick = clearAll;

    fileInput.addEventListener("change", (e) => addImagesFromFiles(e.target.files));

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("dragover");
    });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      addImagesFromFiles(e.dataTransfer.files);
    });

    document.addEventListener("paste", addImagesFromClipboard);
  </script>
</body>
</html>

<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3665/3665980.png" />

  <style>
    html, body{overflow-x:hidden}
    body{font-family:system-ui,Tahoma,Arial;margin:0;background:#fafafa;color:#111}
    .wrap{max-width:1100px;margin:auto;padding:16px;overflow-x:hidden}

    .muted{color:#666;font-size:13px}
    .btn{border:1px solid #e7e7e7;background:#fff;padding:10px 12px;border-radius:10px;cursor:pointer}
    .pill{display:inline-block;padding:4px 8px;border:1px solid #e7e7e7;border-radius:999px;font-size:12px;color:#444}
    input{padding:10px;border:1px solid #e7e7e7;border-radius:10px;font-family:inherit}
    select{padding:10px;border:1px solid #e7e7e7;border-radius:10px;font-family:inherit;background:#fff}

    /* ===== Sidebar ===== */
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
    .brand b{font-size:20px}
    .menuBtn{border:1px solid #e7e7e7;background:#fff;padding:10px 12px;border-radius:10px;cursor:pointer}

    .sidebarOverlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:50}
    .sidebar{
      position:fixed;top:0;right:0;height:100vh;width:min(280px,82vw);
      background:#fff;border-left:1px solid #eee;z-index:60;
      transform:translateX(100%);transition:transform .2s ease;
      display:flex;flex-direction:column;padding:14px;box-sizing:border-box
    }
    .sidebar.open{transform:translateX(0)}
    .sidebarOverlay.open{display:block}
    .sidebarHeader{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .sidebarHeader b{font-size:16px}
    .sidebar a,.sidebar button{
      width:100%;text-align:right;border:1px solid #e7e7e7;background:#fff;
      padding:10px 12px;border-radius:10px;cursor:pointer;margin-top:8px;font-family:inherit;
      box-sizing:border-box
    }
    .sidebar a{color:#111;text-decoration:none;display:block}
    .sidebar .danger{border-color:#f2c2c2;color:#b00020}

    /* ===== Layout ===== */
    .grid{display:grid;grid-template-columns:320px 1fr;gap:12px;min-width:0}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e7e7e7;border-radius:14px;padding:12px;min-width:0}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}

    .orderItem{border:1px solid #e7e7e7;border-radius:12px;padding:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .orderItem.active{border-color:#111}

    .nav{display:flex;justify-content:space-between;align-items:center;margin:12px 0;gap:10px}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumbs img{width:96px;height:96px;object-fit:cover;border-radius:12px;border:1px solid #eee;cursor:pointer}

    #lightbox{
      position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;
      padding:16px;z-index:100;gap:16px
    }
    #lightbox img{max-width:92vw;max-height:92vh;border-radius:16px}
    .lightboxBtn{
      position:absolute;border:none;background:rgba(0,0,0,.6);color:#fff;cursor:pointer;
      width:44px;height:44px;border-radius:999px;display:flex;align-items:center;justify-content:center;
      font-size:24px;line-height:1
    }
    .lightboxCount{
      position:absolute;top:20px;left:20px;background:rgba(0,0,0,.55);color:#fff;
      padding:6px 10px;border-radius:999px;font-size:13px
    }
    .lightboxClose{top:20px;right:20px}
    .lightboxNav{top:50%;transform:translateY(-50%)}
    .lightboxPrev{left:20px}
    .lightboxNext{right:20px}
    @media(max-width:700px){
      .lightboxBtn{width:38px;height:38px;font-size:20px}
      .lightboxPrev{left:10px}
      .lightboxNext{right:10px}
      .lightboxClose{top:12px;right:12px}
      .lightboxCount{top:12px;left:12px;font-size:12px}
    }

    #content { font-size: 18px; line-height: 1.7; }
    #content b { font-size: 19px; }

    .listTable{width:100%;border-collapse:collapse;margin-top:12px}
    .listTable th,.listTable td{border-bottom:1px solid #eee;padding:10px;text-align:right;vertical-align:top}
    .listTable th{color:#666;font-size:13px}
    .listThumbs{display:flex;gap:6px;flex-wrap:wrap}
    .listThumbs img{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid #eee;cursor:pointer}
    #listView{overflow-x:auto;-webkit-overflow-scrolling:touch;max-width:100%}
    #listView .listTable{min-width:720px}

    .toggleRow{display:flex;gap:10px;align-items:center;margin-top:8px}
    .toggleRow input{width:18px;height:18px}
    .iconBtn{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center}
    .iconBtn img{width:22px;height:22px;display:block}
    .priceRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .waBtn{font-family:inherit}
    .waBtn:hover{border-color:#111}

    /* ===== Search ===== */
    .searchBox{width:100%;max-width:420px}
    .searchResults{margin-top:8px;border:1px solid #eee;border-radius:12px;overflow:hidden}
    .searchResults button{
      width:100%;text-align:right;background:#fff;border:none;padding:10px;cursor:pointer;border-bottom:1px solid #eee
    }
    .searchResults button:last-child{border-bottom:none}
    .searchResults button:hover{background:#fafafa}
    .highlight{background:#fff8d6;padding:6px 8px;border-radius:10px}

    .bagField{display:inline-flex;flex-direction:column;gap:6px}
    .bagDisplay{display:flex;align-items:center;gap:8px}
    .bagValue{display:inline-flex;align-items:center;border:1px solid #e7e7e7;border-radius:10px;padding:8px 10px;background:#fff;font-size:14px}
    .bagEditor{display:flex;flex-direction:column;align-items:flex-start;gap:8px}
    .bagActions{display:flex;gap:8px;align-items:center}
    .bagMsg{font-size:13px;color:#2e7d32}
  </style>
</head>
<body>

<div class="sidebarOverlay" id="sidebarOverlay"></div>
<aside class="sidebar" id="sidebar">
  <div class="sidebarHeader">
    <b>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</b>
    <button class="menuBtn" id="closeSidebarBtn" type="button">âœ•</button>
  </div>
  <div id="sidebarContent"></div>
</aside>

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <b>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</b>
      <div class="muted">Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
    </div>
    <button class="menuBtn" id="openSidebarBtn" type="button">â˜°</button>
  </div>

  <!-- Search row -->
  <div class="row" style="margin-bottom:12px">
    <input id="searchInput" class="searchBox" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†...">
    <span class="pill" id="searchCount" style="display:none"></span>
  </div>
  <div id="searchResults" class="searchResults" style="display:none"></div>

  <div class="grid">
    <aside class="card">
      <div class="row" style="justify-content:space-between">
        <b>Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</b>
        <span class="pill" id="ordersCount">0</span>
      </div>
      <div id="ordersList" style="margin-top:10px"></div>
      <div id="ordersEmpty" class="muted" style="margin-top:10px;display:none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª</div>
    </aside>

    <main class="card">
      <div id="viewerEmpty" class="muted">Ø§Ø®ØªØ§Ø±ÙŠ Ø·Ù„Ø¨ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>

      <div id="viewer" style="display:none">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <b id="title"></b>

            <!-- Rahaf only -->
            <div id="placedToggleWrap" class="toggleRow" style="display:none">
              <label class="toggleRow" style="cursor:pointer">
                <input type="checkbox" id="placedAtPickupToggle">
                <span>ØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span>
              </label>
              <span id="placedToggleMsg" class="muted"></span>
            </div>
          </div>

          <div class="row">
            <span class="pill" id="purchaseCount">0</span>
            <button class="btn iconBtn" id="viewToggleBtn" type="button" aria-label="Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
              <img src="https://cdn-icons-png.flaticon.com/512/8616/8616159.png" alt="">
            </button>
          </div>
        </div>

        <div class="nav" id="cardNav">
          <button class="btn" id="prev">â†’</button>
          <span id="counter" class="pill"></span>
          <button class="btn" id="next">â†</button>
        </div>

        <div id="content"></div>
        <div id="listView" style="display:none"></div>
      </div>
    </main>
  </div>
</div>

<div id="lightbox">
  <button type="button" class="lightboxBtn lightboxClose" id="lightboxClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
  <div class="lightboxCount" id="lightboxCount" aria-live="polite"></div>
  <button type="button" class="lightboxBtn lightboxNav lightboxPrev" id="lightboxPrev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚">â€¹</button>
  <img alt="ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø©">
  <button type="button" class="lightboxBtn lightboxNav lightboxNext" id="lightboxNext" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ">â€º</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL="https://maucjvxhrnkdeybltjco.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_0N65DXPMsk_3WVcLQ9wavQ_p9HgB_Bo";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const BUCKET="purchase-images";

const EMAIL_RAHAF = "rahaf@she-store.com";
const EMAIL_REEM  = "reem@she-store.com";
const EMAIL_LAAURA= "laaura@she-store.com";
const WHATSAPP_ICON = "https://cdn-icons-png.flaticon.com/512/3670/3670051.png";

function escapeHtml(s=""){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]))}
function escapeAttr(s=""){ return escapeHtml(s); }
function isMobile(){ return window.matchMedia("(max-width: 900px)").matches; }

function parsePrice(v){
  if(v === null || v === undefined) return 0;
  if(typeof v === "number") return isFinite(v) ? v : 0;
  const s = String(v).replace(/[, ]/g, "").replace(/[â‚ª]/g, "");
  const m = s.match(/-?\d+(?:\.\d+)?/);
  return m ? Number(m[0]) : 0;
}
function formatILS(n){
  const x = Number(parsePrice(n));
  if(!isFinite(x)) return "0";
  const fixed = x.toFixed(2);
  return fixed.endsWith(".00") ? String(Math.round(x)) : fixed;
}

/* ===== Auth + gate ===== */
async function requireAuth(){
  const { data } = await sb.auth.getSession();
  if(!data.session){
    window.location.href="./login.html?next=view.html";
    return false;
  }
  return true;
}

let myEmail = "";
async function loadMe(){
  const { data } = await sb.auth.getUser();
  myEmail = (data?.user?.email || "").toLowerCase();
}

async function getMyRole(){
  const { data: u } = await sb.auth.getUser();
  const email = (u?.user?.email || "").toLowerCase();
  const userId = u?.user?.id || "";
  if(!userId) return { email, role:"viewer" };

  const { data: r, error } = await sb
    .from("user_roles")
    .select("role")
    .eq("user_id", userId)
    .maybeSingle();

  if(error){
    console.error("ROLE READ ERROR:", error);
    return { email, role:"viewer" };
  }
  return { email, role: (r?.role || "viewer") };
}

async function guardViewAccess(){
  const ok = await requireAuth();
  if(!ok) return;

  const me = await getMyRole();
  myEmail = me.email;

  if(myEmail === EMAIL_LAAURA){
    window.location.replace("./pickuppoint.html");
    return;
  }

  if(myEmail !== EMAIL_RAHAF && myEmail !== EMAIL_REEM){
    window.location.replace("./login.html");
    return;
  }
}

/* ===== Sidebar ===== */
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("sidebarOverlay");
const openSidebarBtn = document.getElementById("openSidebarBtn");
const closeSidebarBtn = document.getElementById("closeSidebarBtn");

function openSidebar(){
  sidebar.classList.add("open");
  overlay.classList.add("open");
}
function closeSidebar(){
  sidebar.classList.remove("open");
  overlay.classList.remove("open");
}
function toggleSidebar(){
  if(sidebar.classList.contains("open")){
    closeSidebar();
    return;
  }
  openSidebar();
}

openSidebarBtn.onclick = toggleSidebar;
closeSidebarBtn.onclick = closeSidebar;
overlay.onclick = closeSidebar;
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeSidebar(); });
window.addEventListener("pageshow", closeSidebar);

function renderSidebar(){
  const wrap = document.getElementById("sidebarContent");
  wrap.innerHTML = "";

  const link = (text, href)=>{
    const a = document.createElement("a");
    a.href = href;
    a.textContent = text;
    a.onclick = ()=> closeSidebar();
    wrap.appendChild(a);
  };
  const btn = (text, cls, onClick)=>{
    const b = document.createElement("button");
    b.type="button";
    if(cls) b.className = cls;
    b.textContent = text;
    b.onclick = async ()=>{
      await onClick();
      closeSidebar();
    };
    wrap.appendChild(b);
  };

  if(myEmail === EMAIL_RAHAF){
    link("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª", "./index.html?tab=orders");
    link("Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ§Ù„ØªØ­ØµÙŠÙ„", "./pickup-dashboard.html");
    link("Ø§Ù„Ù…Ø§Ù„ÙŠØ©", "./finance.html");
  }

  if(myEmail === EMAIL_REEM){
    link("Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ§Ù„ØªØ­ØµÙŠÙ„", "./pickup-dashboard.html");
  }

  btn("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", "danger", async ()=>{
    await sb.auth.signOut();
    window.location.href="./login.html";
  });
}

/* ===== DOM ===== */
const ordersListEl = document.getElementById("ordersList");
const ordersEmptyEl = document.getElementById("ordersEmpty");
const ordersCountEl = document.getElementById("ordersCount");

const viewerEmpty = document.getElementById("viewerEmpty");
const viewer = document.getElementById("viewer");
const title = document.getElementById("title");
const content = document.getElementById("content");
const listView = document.getElementById("listView");
const counter = document.getElementById("counter");
const prev = document.getElementById("prev");
const next = document.getElementById("next");
const purchaseCount = document.getElementById("purchaseCount");
const viewToggleBtn = document.getElementById("viewToggleBtn");
const cardNav = document.getElementById("cardNav");

const placedToggleWrap = document.getElementById("placedToggleWrap");
const placedAtPickupToggle = document.getElementById("placedAtPickupToggle");
const placedToggleMsg = document.getElementById("placedToggleMsg");

const searchInput = document.getElementById("searchInput");
const searchResultsEl = document.getElementById("searchResults");
const searchCountEl = document.getElementById("searchCount");

const lb = document.getElementById("lightbox");
const lbImg = lb ? lb.querySelector("img") : null;
const lbClose = document.getElementById("lightboxClose");
const lbPrev = document.getElementById("lightboxPrev");
const lbNext = document.getElementById("lightboxNext");
const lbCount = document.getElementById("lightboxCount");
let lightboxImages = [];
let lightboxIndex = 0;
let touchStartX = 0;
let touchStartY = 0;

function updateLightboxNav(){
  const hasMultiple = lightboxImages.length > 1;
  if(lbPrev) lbPrev.style.display = hasMultiple ? "flex" : "none";
  if(lbNext) lbNext.style.display = hasMultiple ? "flex" : "none";
  if(lbCount){
    const total = lightboxImages.length;
    lbCount.textContent = total ? `${lightboxIndex + 1}/${total}` : "";
    lbCount.style.display = total > 1 ? "inline-flex" : "none";
  }
}
function setLightboxIndex(nextIndex){
  if(!lightboxImages.length) return;
  const total = lightboxImages.length;
  lightboxIndex = (nextIndex + total) % total;
  if(lbImg) lbImg.src = lightboxImages[lightboxIndex];
  updateLightboxNav();
}
function openLightbox(images, index){
  if(!lb || !lbImg) return;
  lightboxImages = images && images.length ? images : [];
  lightboxIndex = Math.max(0, Math.min(index || 0, lightboxImages.length - 1));
  lbImg.src = lightboxImages[lightboxIndex] || "";
  updateLightboxNav();
  lb.style.display = "flex";
}
function closeLightbox(){
  if(!lb || !lbImg) return;
  lb.style.display = "none";
  lbImg.src = "";
  lightboxImages = [];
  lightboxIndex = 0;
}
function isLightboxOpen(){
  return lb && lb.style.display === "flex";
}
function getGalleryImages(img){
  const container = img.closest(".thumbs, .listThumbs");
  if(!container) return { images:[img.src], index:0 };
  const imgs = Array.from(container.querySelectorAll("img"));
  const images = imgs.map((item)=>item.src);
  const index = Math.max(0, imgs.indexOf(img));
  return { images, index };
}
if(lb){
  lb.addEventListener("click", (e)=>{
    if(e.target === lb) closeLightbox();
  });
  lb.addEventListener("touchstart", (e)=>{
    if(!e.touches || !e.touches.length) return;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }, { passive:true });
  lb.addEventListener("touchend", (e)=>{
    if(!isLightboxOpen() || lightboxImages.length < 2) return;
    const touch = e.changedTouches && e.changedTouches[0];
    if(!touch) return;
    const dx = touch.clientX - touchStartX;
    const dy = touch.clientY - touchStartY;
    if(Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy)){
      if(dx < 0) setLightboxIndex(lightboxIndex + 1);
      else setLightboxIndex(lightboxIndex - 1);
    }
  });
}
if(lbClose) lbClose.addEventListener("click", (e)=>{ e.stopPropagation(); closeLightbox(); });
if(lbPrev) lbPrev.addEventListener("click", (e)=>{ e.stopPropagation(); setLightboxIndex(lightboxIndex - 1); });
if(lbNext) lbNext.addEventListener("click", (e)=>{ e.stopPropagation(); setLightboxIndex(lightboxIndex + 1); });
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeLightbox();
  if(!isLightboxOpen()) return;
  if(e.key === "ArrowLeft") setLightboxIndex(lightboxIndex - 1);
  if(e.key === "ArrowRight") setLightboxIndex(lightboxIndex + 1);
});

let orders = [];
let activeOrder = null;
let purchases = [];
let idx = 0;
let highlightPurchaseId = null;
let viewMode = "card";
const canEditBagSize = () => myEmail === EMAIL_RAHAF || myEmail === EMAIL_REEM;

function bagSizeEditor(p){
  const current = p.bag_size || "ÙƒÙŠØ³ ØµØºÙŠØ±";
  return `
    <div class="bagField" data-bag-field="${p.id}" data-bag-value="${escapeAttr(current)}">
      <div class="bagDisplay" data-bag-display="${p.id}">
        <span class="bagValue">${escapeHtml(current)}</span>
        <button class="btn" type="button" data-bag-edit="${p.id}" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ÙƒÙŠØ³">âœï¸</button>
      </div>
      <span class="bagMsg" data-bag-msg="${p.id}" aria-live="polite"></span>
      <div class="bagEditor" data-bag-editor="${p.id}" style="display:none">
        <select data-bag-select="${p.id}">
          <option value="ÙƒÙŠØ³ ÙƒØ¨ÙŠØ±" ${current === "ÙƒÙŠØ³ ÙƒØ¨ÙŠØ±" ? "selected" : ""}>ÙƒÙŠØ³ ÙƒØ¨ÙŠØ±</option>
          <option value="ÙƒÙŠØ³ ØµØºÙŠØ±" ${current === "ÙƒÙŠØ³ ØµØºÙŠØ±" ? "selected" : ""}>ÙƒÙŠØ³ ØµØºÙŠØ±</option>
        </select>
        <div class="bagActions">
          <button class="btn primary" type="button" data-bag-save="${p.id}">Ø­ÙØ¸</button>
          <button class="btn" type="button" data-bag-cancel="${p.id}">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  `;
}
async function updateBagSize(purchaseId, nextValue){
  const { error } = await sb.from("purchases").update({ bag_size: nextValue }).eq("id", purchaseId);
  if(error){
    console.error(error);
    alert("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… Ø§Ù„ÙƒÙŠØ³");
    return false;
  }
  const target = purchases.find((item)=>String(item.id) === String(purchaseId));
  if(target) target.bag_size = nextValue;
  return true;
}
function setBagFieldValue(fieldEl, value){
  fieldEl.dataset.bagValue = value;
  const valueEl = fieldEl.querySelector(".bagValue");
  if(valueEl) valueEl.textContent = value;
  const selectEl = fieldEl.querySelector("select[data-bag-select]");
  if(selectEl) selectEl.value = value;
}
function setBagMessage(fieldEl, message){
  const msgEl = fieldEl.querySelector("[data-bag-msg]");
  if(msgEl) msgEl.textContent = message;
}
function toggleBagEditor(fieldEl, isEditing){
  const displayEl = fieldEl.querySelector("[data-bag-display]");
  const editorEl = fieldEl.querySelector("[data-bag-editor]");
  if(displayEl) displayEl.style.display = isEditing ? "none" : "flex";
  if(editorEl) editorEl.style.display = isEditing ? "flex" : "none";
  if(isEditing){
    setBagMessage(fieldEl, "");
  }
  if(!isEditing){
    const selectEl = fieldEl.querySelector("select[data-bag-select]");
    if(selectEl){
      selectEl.value = fieldEl.dataset.bagValue || selectEl.value;
    }
  }
}
function wireBagSizeEditors(scope){
  if(!scope) return;
  scope.querySelectorAll("[data-bag-field]").forEach(fieldEl=>{
    const purchaseId = fieldEl.dataset.bagField;
    const editBtn = fieldEl.querySelector(`[data-bag-edit="${purchaseId}"]`);
    const saveBtn = fieldEl.querySelector(`[data-bag-save="${purchaseId}"]`);
    const cancelBtn = fieldEl.querySelector(`[data-bag-cancel="${purchaseId}"]`);
    const selectEl = fieldEl.querySelector(`select[data-bag-select="${purchaseId}"]`);

    if(editBtn){
      editBtn.onclick = () => toggleBagEditor(fieldEl, true);
    }
    if(cancelBtn){
      cancelBtn.onclick = () => {
        setBagMessage(fieldEl, "");
        toggleBagEditor(fieldEl, false);
      };
    }
    if(saveBtn && selectEl){
      saveBtn.onclick = async () => {
        const nextValue = selectEl.value;
        const ok = await updateBagSize(purchaseId, nextValue);
        if(ok){
          setBagFieldValue(fieldEl, nextValue);
          toggleBagEditor(fieldEl, false);
          setBagMessage(fieldEl, "âœ…ØªÙ…");
        }
      };
    }
  });
}

function showViewer(on){
  viewer.style.display = on ? "" : "none";
  viewerEmpty.style.display = on ? "none" : "";
}

function setViewMode(mode){
  viewMode = mode;
  const isCard = viewMode === "card";
  viewToggleBtn.setAttribute("aria-label", isCard ? "Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" : "Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª");
  const icon = isCard
    ? "https://cdn-icons-png.flaticon.com/512/1950/1950630.png"
    : "https://cdn-icons-png.flaticon.com/512/8616/8616159.png";
  viewToggleBtn.innerHTML = `<img src="${icon}" alt="">`;
  cardNav.style.display = isCard ? "" : "none";
  content.style.display = isCard ? "" : "none";
  listView.style.display = isCard ? "none" : "";
  closeSidebar();
}

function canShowWhatsapp(){
  return myEmail === EMAIL_RAHAF && !!activeOrder?.arrived && !!activeOrder?.placed_at_pickup;
}

function normalizePhone(value){
  return String(value || "").replace(/\s+/g, "").replace(/^\+/, "");
}

function isValidPhone(value){
  return /^(970|972)\d{7,9}$/.test(value);
}

function buildWhatsappMessage(pickupPoint, price){
  const priceText = formatILS(price);
  if(pickupPoint === "Ù…Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…"){
    return [
      "Ù…Ø±Ø­Ø¨Ø§ Ø­Ø¨ÙŠØ¨ØªÙŠğŸ’–",
      "Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ù‡Ø² Ø¨Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…",
      "ğŸ“ÙƒØ§ÙÙŠÙ‡ la aura Ø³ÙˆÙ‚ Ø§Ù„Ø°Ù‡Ø¨",
      "â° Ø¨ÙØªØ­ÙˆØ§ Ù…Ù† Ø§Ù„Ù¨ ØµØ¨Ø§Ø­Ø§Ù‹ Ù„Ù„Ù¡Ù  Ù…Ø³Ø§Ø¡Ù‹",
      `ğŸ“¦ Ø­Ø³Ø§Ø¨Ùƒ: ${priceText} Ø´ÙŠÙƒÙ„`
    ].join("\n");
  }
  if(pickupPoint === "Ù…Ù† Ø§Ù„Ø¨ÙŠØª"){
    return [
      "Ù…Ø±Ø­Ø¨Ø§ Ø­Ø¨ÙŠØ¨ØªÙŠğŸ’–",
      "Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ù‡Ø² Ø¹Ù†Ø¯ÙŠ Ø¨Ø§Ù„Ø¨ÙŠØª",
      "Ø®Ø¨Ø±ÙŠÙ†ÙŠ Ù‚Ø¨Ù„ Ø¨ÙˆÙ‚Øª ÙˆÙŠÙ†ØªØ§ Ø±Ø­ ØªØ³ØªÙ„Ù…ÙŠğŸ’Œ",
      `ğŸ“¦Ø­Ø³Ø§Ø¨Ùƒ: ${priceText} Ø´ÙŠÙƒÙ„`
    ].join("\n");
  }
  return [
    "Ù…Ø±Ø­Ø¨Ø§ Ø­Ø¨ÙŠØ¨ØªÙŠğŸ’–",
    `Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… (${pickupPoint || "â€”"})`,
    `ğŸ“¦ Ø­Ø³Ø§Ø¨Ùƒ: ${priceText} Ø´ÙŠÙƒÙ„`
  ].join("\n");
}

async function openWhatsappForPurchase(purchaseId){
  try{
    const { data: purchase, error: purchaseErr } = await sb
      .from("purchases")
      .select("id, order_id, price, pickup_point, customer_id")
      .eq("id", purchaseId)
      .maybeSingle();

    if(purchaseErr || !purchase){
      alert("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†.");
      return;
    }

    const { data: order, error: orderErr } = await sb
      .from("orders")
      .select("id, arrived, placed_at_pickup")
      .eq("id", purchase.order_id)
      .maybeSingle();

    if(orderErr || !order){
      alert("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ÙŠØ©.");
      return;
    }

    if(!order.arrived || !order.placed_at_pickup){
      alert("ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ÙˆØ§ØµÙ„Ø© ÙˆØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ Ø¨Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹.");
      return;
    }

    if(!purchase.customer_id){
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†.");
      return;
    }

    const { data: customer, error: customerErr } = await sb
      .from("customers")
      .select("phone")
      .eq("id", purchase.customer_id)
      .maybeSingle();

    if(customerErr || !customer?.phone){
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†.");
      return;
    }

    const phone = normalizePhone(customer.phone);
    if(!isValidPhone(phone)){
      alert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­.");
      return;
    }

    const message = buildWhatsappMessage(purchase.pickup_point, purchase.price);
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
    window.open(url, "_blank");
  } catch (err){
    console.error(err);
    alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨.");
  }
}

/* ===== Load orders ===== */
async function loadOrders(){
  const { data, error } = await sb
    .from("orders")
    .select("*")
    .eq("arrived", true)
    .order("created_at",{ascending:false});

  if(error){ console.error(error); return; }

  orders = data || [];
  ordersCountEl.textContent = orders.length;

  ordersListEl.innerHTML = "";
  ordersEmptyEl.style.display = orders.length ? "none" : "";

  orders.forEach(o=>{
    const div = document.createElement("div");
    div.className = "orderItem" + (activeOrder?.id === o.id ? " active" : "");
    div.innerHTML = `<span>${escapeHtml(o.order_name || "")}</span><span class="pill">Ø¹Ø±Ø¶</span>`;
    div.onclick = () => selectOrder(o, {fromSidebar:true});
    ordersListEl.appendChild(div);
  });
}

/* ===== Rahaf-only toggle ===== */
async function setPlacedToggleUI(order){
  if(myEmail !== EMAIL_RAHAF){
    placedToggleWrap.style.display = "none";
    return;
  }

  placedToggleWrap.style.display = "";
  placedAtPickupToggle.checked = !!order.placed_at_pickup;
  placedToggleMsg.textContent = "";

  placedAtPickupToggle.onchange = async ()=>{
    if(!activeOrder) return;
    placedToggleMsg.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

    const val = placedAtPickupToggle.checked;
    const payload = val
      ? { placed_at_pickup: true, placed_at_pickup_at: new Date().toISOString() }
      : { placed_at_pickup: false, placed_at_pickup_at: null };

    const { error } = await sb.from("orders").update(payload).eq("id", activeOrder.id);

    if(error){
      console.error(error);
      placedToggleMsg.textContent = "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸.";
      placedAtPickupToggle.checked = !val;
      return;
    }

    placedToggleMsg.textContent = "ØªÙ… âœ…";
    activeOrder.placed_at_pickup = payload.placed_at_pickup;
    activeOrder.placed_at_pickup_at = payload.placed_at_pickup_at;
    await loadOrders();
  };
}

/* ===== Select order ===== */
async function selectOrder(o, opts={}){
  activeOrder = o;
  idx = 0;

  // mobile: if menu open, close it so it doesn't cover
  if(isMobile()) closeSidebar();

  await loadOrders();

  const { data, error } = await sb
    .from("purchases")
    .select("*,purchase_links(url),purchase_images(storage_path)")
    .eq("order_id", o.id)
    .order("created_at",{ascending:false});

  if(error){ console.error(error); return; }

  purchases = data || [];
  title.textContent = o.order_name || "";

  const totalItems = purchases.reduce((sum,p)=> sum + Number(p.qty || 0), 0);
  purchaseCount.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${purchases.length} â€” Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚Ø·Ø¹: ${totalItems}`;

  await setPlacedToggleUI(o);

  showViewer(true);
  setViewMode(viewMode);
  render();
}

/* ===== Render purchase ===== */
function render(){
  if(!purchases.length){
    counter.textContent = "0/0";
    content.innerHTML = `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</div>`;
    listView.innerHTML = `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</div>`;
    return;
  }

  const p = purchases[idx];
  counter.textContent = `${idx+1}/${purchases.length}`;

  const imgs = (p.purchase_images||[]).map(i=>{
    const url = sb.storage.from(BUCKET).getPublicUrl(i.storage_path).data.publicUrl;
    return `<img src="${escapeAttr(url)}" alt="ØµÙˆØ±Ø©">`;
  }).join("");

  const links = (p.purchase_links||[])
    .map((l,i)=>`<a href="${escapeAttr(l.url)}" target="_blank" rel="noopener">Ø±Ø§Ø¨Ø· ${i+1}</a>`)
    .join("<br>") || "â€”";

  const pickup = p.pickup_point || "â€”";
  const note = (p.note || "").trim();
  const bagValue = p.bag_size || "ÙƒÙŠØ³ ØµØºÙŠØ±";
  const bagMarkup = canEditBagSize() ? bagSizeEditor(p) : escapeHtml(bagValue);

  const highlight = (highlightPurchaseId && highlightPurchaseId === p.id)
    ? `<div class="highlight" style="margin-bottom:10px">âœ… Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¨Ø­Ø«</div>`
    : "";

  const whatsappBtn = canShowWhatsapp()
    ? `<button class="btn waBtn" type="button" data-wa="${p.id}" aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨">Ø§Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</button>`
    : "";

  content.innerHTML = `
    ${highlight}
    <div><b>Ø§Ù„Ø²Ø¨ÙˆÙ†:</b> ${escapeHtml(p.customer_name || "")}</div>
    <div><b>Ø§Ù„Ø¹Ø¯Ø¯:</b> ${escapeHtml(p.qty ?? "")}</div>
    <div class="priceRow"><div><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${escapeHtml(p.price ?? "")}</div></div>
    <div><b>Ø­Ø¬Ù… Ø§Ù„ÙƒÙŠØ³:</b> ${bagMarkup}</div>
    <div style="margin-top:8px"><b>Ø±ÙˆØ§Ø¨Ø·:</b><br>${links}</div>
    <div style="margin-top:10px"><b>Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</b> ${escapeHtml(pickup)}</div>
    <div class="thumbs">${imgs || ""}</div>
    <div style="margin-top:10px"><b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ${note ? escapeHtml(note) : "â€”"}</div>
    ${whatsappBtn ? `<div style="margin-top:10px">${whatsappBtn}</div>` : ""}
  `;

  content.querySelectorAll("button[data-wa]").forEach(btn=>{
    btn.onclick = () => openWhatsappForPurchase(btn.dataset.wa);
  });

  content.querySelectorAll("img").forEach(img=>{
    if(img.classList.contains("waIcon")) return;
    img.onclick = () => {
      const { images, index } = getGalleryImages(img);
      openLightbox(images, index);
    };
  });
  if(canEditBagSize()) wireBagSizeEditors(content);

  renderList();
}

function renderList(){
  const rows = purchases.map((p, i)=>{
    const imgs = (p.purchase_images||[]).map(img=>{
      const url = sb.storage.from(BUCKET).getPublicUrl(img.storage_path).data.publicUrl;
      return `<img src="${escapeAttr(url)}" alt="ØµÙˆØ±Ø©">`;
    }).join("");

    const links = (p.purchase_links||[])
      .map((l, idx)=>`<a href="${escapeAttr(l.url)}" target="_blank" rel="noopener">Ø±Ø§Ø¨Ø· ${idx+1}</a>`)
      .join("<br>") || "â€”";

    const pickup = p.pickup_point || "â€”";
    const note = (p.note || "").trim();
    const bagValue = p.bag_size || "ÙƒÙŠØ³ ØµØºÙŠØ±";
    const bagMarkup = canEditBagSize() ? bagSizeEditor(p) : escapeHtml(bagValue);
    const highlightClass = (highlightPurchaseId && highlightPurchaseId === p.id) ? "highlight" : "";
    const waBtn = canShowWhatsapp()
      ? `<button class="btn waBtn" type="button" data-wa="${p.id}" aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨">Ø§Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</button>`
      : "";
    const whatsappMarkup = waBtn || "â€”";

    return `
      <tr class="${highlightClass}">
        <td>${i + 1}</td>
        <td>${escapeHtml(p.customer_name || "")}</td>
        <td>${escapeHtml(p.qty ?? "")}</td>
        <td><div class="priceRow">${escapeHtml(p.price ?? "")}</div></td>
        <td>${escapeHtml(pickup)}</td>
        <td>${bagMarkup}</td>
        <td>${links}</td>
        <td><div class="listThumbs">${imgs || ""}</div></td>
        <td>${note ? escapeHtml(note) : "â€”"}</td>
        <td>${whatsappMarkup}</td>
      </tr>
    `;
  }).join("");

  listView.innerHTML = `
    <table class="listTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
          <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>
          <th>Ø­Ø¬Ù… Ø§Ù„ÙƒÙŠØ³</th>
          <th>Ø±ÙˆØ§Ø¨Ø·</th>
          <th>ØµÙˆØ±</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          <th>ÙˆØ§ØªØ³Ø§Ø¨</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  listView.querySelectorAll("button[data-wa]").forEach(btn=>{
    btn.onclick = () => openWhatsappForPurchase(btn.dataset.wa);
  });

  listView.querySelectorAll("img").forEach(img=>{
    if(img.classList.contains("waIcon")) return;
    img.onclick = () => {
      const { images, index } = getGalleryImages(img);
      openLightbox(images, index);
    };
  });
  if(canEditBagSize()) wireBagSizeEditors(listView);
}

prev.onclick = ()=>{
  if(!purchases.length) return;
  idx = (idx - 1 + purchases.length) % purchases.length;
  highlightPurchaseId = null;
  render();
};
next.onclick = ()=>{
  if(!purchases.length) return;
  idx = (idx + 1) % purchases.length;
  highlightPurchaseId = null;
  render();
};
// lightbox close handled by overlay/close button

viewToggleBtn.onclick = ()=>{
  viewMode = viewMode === "card" ? "list" : "card";
  setViewMode(viewMode);
  render();
};

/* ===== Search by customer name (across all orders) ===== */
let searchTimer = null;

searchInput.addEventListener("input", ()=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(runSearch, 250);
});

function clearSearchUI(){
  searchResultsEl.style.display = "none";
  searchCountEl.style.display = "none";
  searchResultsEl.innerHTML = "";
}

async function runSearch(){
  const q = (searchInput.value || "").trim();
  if(q.length < 2){ clearSearchUI(); return; }

  // Search purchases by customer name
  const { data, error } = await sb
    .from("purchases")
    .select("id, order_id, customer_name, price, qty, created_at")
    .ilike("customer_name", `%${q}%`)
    .order("created_at",{ascending:false})
    .limit(50);

  if(error){ console.error(error); return; }

  const results = data || [];
  searchCountEl.textContent = `${results.length} Ù†ØªÙŠØ¬Ø©`;
  searchCountEl.style.display = "";
  searchResultsEl.style.display = "";
  searchResultsEl.innerHTML = "";

  results.forEach(r=>{
    const ord = orders.find(o=>o.id === r.order_id);
    const btn = document.createElement("button");
    btn.innerHTML = `
      <b>${escapeHtml(r.customer_name || "")}</b>
      <div class="muted">${escapeHtml(ord?.order_name || "Ø·Ù„Ø¨ÙŠØ©")} â€” Ø§Ù„Ø¹Ø¯Ø¯: ${escapeHtml(r.qty ?? "")} â€” Ø§Ù„Ø³Ø¹Ø±: ${escapeHtml(r.price ?? "")}</div>
    `;
    btn.onclick = async ()=>{
      searchResultsEl.style.display="none";
      highlightPurchaseId = r.id;

      // open order
      if(ord) await selectOrder(ord);

      // jump to that purchase inside current purchases list
      const pos = purchases.findIndex(p=>String(p.id)===String(r.id));
      if(pos >= 0){
        idx = pos;
        render();
      }

      setTimeout(()=>{ highlightPurchaseId = null; }, 2500);
    };
    searchResultsEl.appendChild(btn);
  });
}

/* ===== Init ===== */
(async function init(){
  closeSidebar();
  await guardViewAccess();
  await renderSidebar();
  await loadOrders();
  if(orders.length) selectOrder(orders[0]);
})();
</script>
</body>
</html>
